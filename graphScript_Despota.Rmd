---
title: "DESPOTA (functions and working example)"
output: html_document
---

```{r echo=FALSE, message=FALSE, warning=FALSE, label=dataset}

#DATASET

customer_data <- structure(list(Fresh = c(12669L, 7057L, 6353L, 13265L, 22615L, 
                                          9413L, 12126L, 7579L, 5963L, 6006L, 3366L, 13146L, 31714L, 21217L, 
                                          24653L, 10253L, 1020L, 5876L, 18601L, 7780L, 17546L, 5567L, 31276L, 
                                          26373L, 22647L, 16165L, 9898L, 14276L, 4113L, 43088L, 18815L, 
                                          2612L, 21632L, 29729L, 1502L, 688L, 29955L, 15168L, 4591L, 56159L, 
                                          24025L, 19176L, 10850L, 630L, 9670L, 5181L, 3103L, 44466L, 11519L, 
                                          4967L, 6269L, 3347L, 40721L, 491L, 27329L, 5264L, 4098L, 5417L, 
                                          13779L, 6137L, 8590L, 35942L, 7823L, 9396L, 4760L, 85L, 9L, 19913L, 
                                          2446L, 8352L, 16705L, 18291L, 4420L, 19899L, 8190L, 20398L, 717L, 
                                          12205L, 10766L, 1640L, 7005L, 219L, 10362L, 20874L, 11867L, 16117L, 
                                          22925L, 43265L, 7864L, 24904L, 11405L, 12754L, 9198L, 11314L, 
                                          5626L, 3L, 23L, 403L, 503L, 9658L, 11594L, 1420L, 2932L, 56082L, 
                                          14100L, 15587L, 1454L, 8797L, 1531L, 1406L, 11818L, 12579L, 19046L, 
                                          14438L, 18044L, 11134L, 11173L, 6990L, 20049L, 8258L, 17160L, 
                                          4020L, 12212L, 11170L, 36050L, 76237L, 19219L, 21465L, 140L, 
                                          42312L, 7149L, 2101L, 14903L, 9434L, 7388L, 6300L, 4625L, 3087L, 
                                          13537L, 5387L, 17623L, 30379L, 37036L, 10405L, 18827L, 22039L, 
                                          7769L, 9203L, 5924L, 31812L, 16225L, 1289L, 18840L, 3463L, 622L, 
                                          1989L, 3830L, 17773L, 2861L, 355L, 1725L, 12434L, 15177L, 5531L, 
                                          5224L, 15615L, 4822L, 2926L, 5809L, 5414L, 260L, 200L, 955L, 
                                          514L, 286L, 2343L, 45640L, 12759L, 11002L, 3157L, 12356L, 112151L, 
                                          694L, 36847L, 327L, 8170L, 3009L, 2438L, 8040L, 834L, 16936L, 
                                          13624L, 5509L, 180L, 7107L, 17023L, 30624L, 2427L, 11686L, 9670L, 
                                          3067L, 4484L, 25203L, 583L, 1956L, 1107L, 6373L, 2541L, 1537L, 
                                          5550L, 18567L, 12119L, 7291L, 3317L, 2362L, 2806L, 2532L, 18044L, 
                                          18L, 4155L, 14755L, 5396L, 5041L, 2790L, 7274L, 12680L, 20782L, 
                                          4042L, 1869L, 8656L, 11072L, 2344L, 25962L, 964L, 15603L, 1838L, 
                                          8635L, 18692L, 7363L, 47493L, 22096L, 24929L, 18226L, 11210L, 
                                          6202L, 3062L, 8885L, 13569L, 15671L, 8040L, 3191L, 6134L, 6623L, 
                                          29526L, 10379L, 31614L, 11092L, 8475L, 56083L, 53205L, 9193L, 
                                          7858L, 23257L, 2153L, 1073L, 5909L, 572L, 20893L, 11908L, 15218L, 
                                          4720L, 2083L, 514L, 36817L, 894L, 680L, 27901L, 9061L, 11693L, 
                                          17360L, 3366L, 12238L, 49063L, 25767L, 68951L, 40254L, 7149L, 
                                          15354L, 16260L, 42786L, 2708L, 6022L, 2838L, 3996L, 21273L, 7588L, 
                                          19087L, 8090L, 6758L, 444L, 16448L, 5283L, 2886L, 2599L, 161L, 
                                          243L, 6468L, 17327L, 6987L, 918L, 7034L, 29635L, 2137L, 9784L, 
                                          10617L, 1479L, 7127L, 1182L, 11800L, 9759L, 1774L, 9155L, 15881L, 
                                          13360L, 25977L, 32717L, 4414L, 542L, 16933L, 5113L, 9790L, 11223L, 
                                          22321L, 8565L, 16823L, 27082L, 13970L, 9351L, 3L, 2617L, 381L, 
                                          2320L, 255L, 1689L, 3043L, 1198L, 2771L, 27380L, 3428L, 5981L, 
                                          3521L, 1210L, 608L, 117L, 14039L, 190L, 22686L, 37L, 759L, 796L, 
                                          19746L, 4734L, 2121L, 4627L, 2615L, 4692L, 9561L, 3477L, 22335L, 
                                          6211L, 39679L, 20105L, 3884L, 15076L, 6338L, 5841L, 3136L, 38793L, 
                                          3225L, 4048L, 28257L, 17770L, 34454L, 1821L, 10683L, 11635L, 
                                          1206L, 20918L, 9785L, 9385L, 3352L, 2647L, 518L, 23632L, 12377L, 
                                          9602L, 4515L, 11535L, 11442L, 9612L, 4446L, 27167L, 26539L, 25606L, 
                                          18073L, 6884L, 25066L, 7362L, 8257L, 8708L, 6633L, 2126L, 97L, 
                                          4983L, 5969L, 7842L, 4389L, 5065L, 660L, 8861L, 4456L, 17063L, 
                                          26400L, 17565L, 16980L, 11243L, 13134L, 31012L, 3047L, 8607L, 
                                          3097L, 8533L, 21117L, 1982L, 16731L, 29703L, 39228L, 14531L, 
                                          10290L, 2787L), Milk = c(9656L, 9810L, 8808L, 1196L, 5410L, 8259L, 
                                                                   3199L, 4956L, 3648L, 11093L, 5403L, 1124L, 12319L, 6208L, 9465L, 
                                                                   1114L, 8816L, 6157L, 6327L, 2495L, 4519L, 871L, 1917L, 36423L, 
                                                                   9776L, 4230L, 961L, 803L, 20484L, 2100L, 3610L, 4339L, 1318L, 
                                                                   4786L, 1979L, 5491L, 4362L, 10556L, 15729L, 555L, 4332L, 3065L, 
                                                                   7555L, 11095L, 7027L, 22044L, 14069L, 54259L, 6152L, 21412L, 
                                                                   1095L, 4051L, 3916L, 10473L, 1449L, 3683L, 29892L, 9933L, 1970L, 
                                                                   5360L, 3045L, 38369L, 6245L, 11601L, 1227L, 20959L, 1534L, 6759L, 
                                                                   7260L, 2820L, 2037L, 1266L, 5139L, 5332L, 6343L, 1137L, 3587L, 
                                                                   12697L, 1175L, 3259L, 829L, 9540L, 9232L, 1563L, 3327L, 46197L, 
                                                                   73498L, 5025L, 542L, 3836L, 596L, 2762L, 27472L, 3090L, 12220L, 
                                                                   2920L, 2616L, 254L, 112L, 2182L, 7779L, 10810L, 6459L, 3504L, 
                                                                   2132L, 1014L, 6337L, 10646L, 8397L, 16729L, 1648L, 11114L, 2770L, 
                                                                   2295L, 1080L, 793L, 2521L, 3880L, 1891L, 2344L, 1200L, 3234L, 
                                                                   201L, 10769L, 1642L, 3473L, 1840L, 7243L, 8847L, 926L, 2428L, 
                                                                   589L, 2032L, 1042L, 1882L, 1289L, 8579L, 8080L, 4257L, 4979L, 
                                                                   4280L, 13252L, 7152L, 1596L, 3677L, 8384L, 1936L, 3373L, 584L, 
                                                                   1433L, 1825L, 3328L, 1371L, 9250L, 55L, 10690L, 5291L, 1366L, 
                                                                   6570L, 7704L, 3651L, 540L, 2024L, 15726L, 7603L, 12653L, 6721L, 
                                                                   3195L, 735L, 717L, 8675L, 25862L, 5479L, 7677L, 1208L, 7845L, 
                                                                   6958L, 7330L, 7075L, 4888L, 6036L, 29627L, 8533L, 43950L, 918L, 
                                                                   6448L, 521L, 8002L, 7639L, 11577L, 6250L, 295L, 1461L, 3485L, 
                                                                   1012L, 5139L, 7209L, 7097L, 2154L, 2280L, 13240L, 14399L, 11487L, 
                                                                   685L, 891L, 11711L, 780L, 4737L, 3748L, 12729L, 1895L, 28326L, 
                                                                   1012L, 6602L, 6551L, 10765L, 16599L, 1475L, 7504L, 367L, 899L, 
                                                                   7503L, 1115L, 2527L, 659L, 3243L, 5921L, 2204L, 577L, 2746L, 
                                                                   5989L, 10678L, 1780L, 4984L, 2703L, 6380L, 820L, 3838L, 475L, 
                                                                   2567L, 3575L, 1801L, 659L, 3576L, 7775L, 6154L, 2428L, 346L, 
                                                                   5279L, 3795L, 1993L, 23133L, 1860L, 7961L, 17972L, 489L, 5008L, 
                                                                   1931L, 4563L, 4959L, 4885L, 1110L, 1372L, 1115L, 9679L, 23527L, 
                                                                   9763L, 1222L, 8053L, 258L, 1032L, 5007L, 8323L, 3045L, 1703L, 
                                                                   1610L, 3749L, 829L, 2317L, 6200L, 2884L, 7108L, 3965L, 3613L, 
                                                                   4411L, 640L, 2247L, 2102L, 594L, 286L, 2160L, 3354L, 3086L, 11103L, 
                                                                   2013L, 1897L, 1304L, 3199L, 4560L, 879L, 6243L, 13316L, 5302L, 
                                                                   3688L, 7460L, 12939L, 12867L, 2374L, 1020L, 20655L, 1492L, 2335L, 
                                                                   3737L, 925L, 1795L, 14982L, 1375L, 3088L, 2713L, 25071L, 3696L, 
                                                                   1897L, 713L, 944L, 3587L, 16784L, 1610L, 899L, 2209L, 1486L, 
                                                                   1786L, 14881L, 3216L, 4980L, 928L, 6817L, 1511L, 1347L, 333L, 
                                                                   1188L, 4025L, 5763L, 5758L, 6964L, 1172L, 2602L, 6939L, 7184L, 
                                                                   2380L, 14641L, 1099L, 10044L, 1106L, 6264L, 7393L, 727L, 134L, 
                                                                   1275L, 18664L, 5878L, 2872L, 607L, 1601L, 997L, 873L, 6128L, 
                                                                   2217L, 894L, 1196L, 337L, 3944L, 1887L, 3801L, 6257L, 2256L, 
                                                                   1450L, 8630L, 3154L, 3294L, 5164L, 944L, 4591L, 7435L, 1364L, 
                                                                   21858L, 922L, 3620L, 1916L, 848L, 1530L, 1181L, 2761L, 4180L, 
                                                                   6730L, 865L, 1316L, 11991L, 1666L, 1032L, 577L, 906L, 2801L, 
                                                                   4753L, 11006L, 4613L, 1046L, 5010L, 12844L, 3880L, 3634L, 2096L, 
                                                                   3289L, 3605L, 4859L, 1990L, 6046L, 10940L, 5499L, 8494L, 3783L, 
                                                                   5266L, 4847L, 1377L, 3686L, 2884L, 2408L, 9347L, 16687L, 5970L, 
                                                                   1750L, 4230L, 5506L, 1162L, 3218L, 3922L, 12051L, 1431L, 15488L, 
                                                                   1981L, 1698L), Grocery = c(7561L, 9568L, 7684L, 4221L, 7198L, 
                                                                                              5126L, 6975L, 9426L, 6192L, 18881L, 12974L, 4523L, 11757L, 14982L, 
                                                                                              12091L, 3821L, 12121L, 2933L, 10099L, 9464L, 4602L, 2010L, 4469L, 
                                                                                              22019L, 13792L, 7595L, 2861L, 3045L, 25957L, 2609L, 11107L, 3133L, 
                                                                                              2886L, 7326L, 2262L, 11091L, 5428L, 12477L, 16709L, 902L, 4757L, 
                                                                                              5956L, 14961L, 23998L, 10471L, 21531L, 21955L, 55571L, 10868L, 
                                                                                              28921L, 1980L, 6996L, 5876L, 11532L, 1947L, 5005L, 26866L, 10487L, 
                                                                                              1648L, 8040L, 7854L, 59598L, 6544L, 15775L, 3250L, 45828L, 7417L, 
                                                                                              13462L, 3993L, 1293L, 3202L, 21042L, 2661L, 8713L, 9794L, 3L, 
                                                                                              6532L, 28540L, 2067L, 3655L, 3009L, 14403L, 11009L, 1783L, 4814L, 
                                                                                              92780L, 32114L, 8117L, 4042L, 5330L, 1638L, 2530L, 32034L, 2062L, 
                                                                                              11323L, 6252L, 8118L, 610L, 778L, 1909L, 12144L, 16267L, 7677L, 
                                                                                              8906L, 3445L, 3970L, 10704L, 14886L, 6981L, 28986L, 1694L, 17569L, 
                                                                                              2469L, 1733L, 2000L, 2988L, 3355L, 5380L, 2362L, 2147L, 3412L, 
                                                                                              1498L, 245L, 8814L, 2961L, 7102L, 1658L, 10685L, 3823L, 1510L, 
                                                                                              699L, 314L, 2479L, 1235L, 2174L, 2591L, 7030L, 8282L, 5034L, 
                                                                                              3343L, 7305L, 5189L, 8253L, 1096L, 1988L, 34792L, 2177L, 2707L, 
                                                                                              542L, 1651L, 1765L, 2022L, 3135L, 2368L, 137L, 19460L, 14855L, 
                                                                                              2474L, 9618L, 14682L, 12822L, 283L, 3810L, 26870L, 8584L, 19858L, 
                                                                                              9170L, 3268L, 803L, 2155L, 13430L, 19816L, 6536L, 19805L, 5241L, 
                                                                                              11874L, 6536L, 4533L, 4945L, 2500L, 8887L, 18148L, 10518L, 20170L, 
                                                                                              4710L, 1139L, 854L, 9819L, 11687L, 11522L, 1981L, 1381L, 2251L, 
                                                                                              20292L, 2974L, 5230L, 4897L, 10391L, 6824L, 2112L, 23127L, 24708L, 
                                                                                              9490L, 2216L, 5226L, 23596L, 950L, 6089L, 5838L, 16767L, 1393L, 
                                                                                              39694L, 2062L, 6861L, 11364L, 15538L, 36486L, 2046L, 15205L, 
                                                                                              1390L, 1382L, 10646L, 2856L, 5265L, 1499L, 4157L, 9212L, 1563L, 
                                                                                              572L, 2501L, 5615L, 3828L, 3838L, 3316L, 3833L, 2824L, 3047L, 
                                                                                              593L, 585L, 3779L, 7041L, 2475L, 2914L, 5119L, 10817L, 13916L, 
                                                                                              1777L, 489L, 2406L, 2070L, 1799L, 33586L, 4740L, 16966L, 4748L, 
                                                                                              1495L, 5249L, 1883L, 2124L, 7336L, 2157L, 1094L, 1677L, 6684L, 
                                                                                              15445L, 13699L, 22182L, 2576L, 19847L, 1138L, 975L, 1563L, 6869L, 
                                                                                              1493L, 1841L, 223L, 6964L, 683L, 2543L, 9694L, 2431L, 6235L, 
                                                                                              4252L, 2013L, 12609L, 3600L, 1242L, 2828L, 1296L, 471L, 2642L, 
                                                                                              3261L, 4329L, 12469L, 6550L, 5234L, 3643L, 6986L, 9965L, 2060L, 
                                                                                              6360L, 20399L, 9785L, 13829L, 24773L, 8852L, 21570L, 2842L, 3007L, 
                                                                                              13567L, 2405L, 8280L, 19172L, 2405L, 7647L, 11924L, 2201L, 6114L, 
                                                                                              3558L, 17645L, 2280L, 5167L, 3315L, 11593L, 2464L, 13626L, 1431L, 
                                                                                              1664L, 3389L, 4583L, 5109L, 26839L, 1447L, 67298L, 2743L, 10790L, 
                                                                                              1330L, 2611L, 7021L, 5332L, 9670L, 11238L, 5923L, 26316L, 1763L, 
                                                                                              8335L, 15541L, 12311L, 2028L, 20521L, 1997L, 22294L, 1533L, 21203L, 
                                                                                              2548L, 2012L, 218L, 22272L, 1660L, 2109L, 2006L, 864L, 2453L, 
                                                                                              4438L, 1524L, 8025L, 1664L, 534L, 2406L, 683L, 4955L, 1939L, 
                                                                                              1641L, 7398L, 1668L, 1162L, 13586L, 2648L, 1902L, 10391L, 2146L, 
                                                                                              1617L, 8469L, 3450L, 15400L, 1614L, 2857L, 1573L, 1172L, 1422L, 
                                                                                              1328L, 2313L, 3600L, 3842L, 3204L, 1263L, 9345L, 1428L, 582L, 
                                                                                              935L, 1238L, 2128L, 5091L, 4604L, 3444L, 1167L, 5026L, 18683L, 
                                                                                              6407L, 6100L, 4563L, 3281L, 12400L, 6633L, 3417L, 8552L, 10908L, 
                                                                                              11055L, 18622L, 2223L, 13227L, 9053L, 4172L, 4657L, 12232L, 2593L, 
                                                                                              14316L, 5429L, 4910L, 3580L, 16483L, 5160L, 4754L, 1493L, 7994L, 
                                                                                              16027L, 764L, 30243L, 2232L, 2510L), Frozen = c(214L, 1762L, 
                                                                                                                                              2405L, 6404L, 3915L, 666L, 480L, 1669L, 425L, 1159L, 4400L, 1420L, 
                                                                                                                                              287L, 3095L, 294L, 397L, 134L, 839L, 2205L, 669L, 1066L, 3383L, 
                                                                                                                                              9408L, 5154L, 2915L, 201L, 3151L, 485L, 1158L, 1200L, 1148L, 
                                                                                                                                              2088L, 266L, 6130L, 425L, 833L, 1729L, 1920L, 33L, 10002L, 9510L, 
                                                                                                                                              2033L, 188L, 787L, 541L, 1740L, 1668L, 7782L, 584L, 1798L, 3860L, 
                                                                                                                                              239L, 532L, 744L, 2436L, 1057L, 2616L, 38L, 596L, 129L, 96L, 
                                                                                                                                              3254L, 4154L, 2896L, 3724L, 36L, 175L, 1256L, 5870L, 779L, 10643L, 
                                                                                                                                              5373L, 8872L, 8132L, 1285L, 4407L, 7530L, 869L, 2096L, 868L, 
                                                                                                                                              430L, 283L, 737L, 2320L, 1178L, 1026L, 987L, 6312L, 9735L, 3443L, 
                                                                                                                                              3347L, 8693L, 3232L, 35009L, 206L, 440L, 145L, 774L, 895L, 5639L, 
                                                                                                                                              3252L, 1593L, 2561L, 18028L, 1336L, 910L, 133L, 2471L, 247L, 
                                                                                                                                              673L, 2276L, 805L, 8853L, 3220L, 2555L, 2715L, 1517L, 1647L, 
                                                                                                                                              5343L, 3896L, 2417L, 2395L, 1991L, 2194L, 4787L, 16538L, 8195L, 
                                                                                                                                              880L, 142L, 1718L, 6316L, 346L, 576L, 436L, 720L, 1170L, 4575L, 
                                                                                                                                              661L, 155L, 825L, 2279L, 321L, 2995L, 8425L, 118L, 42L, 926L, 
                                                                                                                                              1286L, 4052L, 800L, 853L, 531L, 3001L, 779L, 75L, 233L, 317L, 
                                                                                                                                              3378L, 930L, 398L, 824L, 1092L, 2665L, 2367L, 2540L, 4425L, 993L, 
                                                                                                                                              405L, 1393L, 2399L, 1116L, 651L, 333L, 937L, 2515L, 52L, 7368L, 
                                                                                                                                              1752L, 1152L, 4477L, 402L, 16745L, 443L, 36534L, 74L, 2181L, 
                                                                                                                                              3470L, 6269L, 2758L, 275L, 7332L, 890L, 547L, 959L, 806L, 7888L, 
                                                                                                                                              18711L, 1127L, 3527L, 520L, 3941L, 3549L, 5065L, 469L, 1383L, 
                                                                                                                                              955L, 878L, 2946L, 1859L, 864L, 1801L, 4736L, 1291L, 1329L, 913L, 
                                                                                                                                              1374L, 179L, 2532L, 1285L, 2306L, 1765L, 91L, 7496L, 5612L, 784L, 
                                                                                                                                              660L, 1759L, 2286L, 950L, 6845L, 8321L, 1439L, 638L, 937L, 4260L, 
                                                                                                                                              1218L, 2312L, 4634L, 1112L, 5243L, 11422L, 2216L, 3752L, 561L, 
                                                                                                                                              1183L, 230L, 1777L, 2077L, 559L, 6340L, 1730L, 6746L, 7683L, 
                                                                                                                                              432L, 4686L, 3242L, 453L, 5004L, 6422L, 3012L, 327L, 6818L, 982L, 
                                                                                                                                              4324L, 61L, 10155L, 2221L, 3975L, 1069L, 2516L, 5500L, 1120L, 
                                                                                                                                              529L, 4802L, 744L, 862L, 4479L, 16919L, 5845L, 1293L, 977L, 1093L, 
                                                                                                                                              5970L, 10303L, 8692L, 1042L, 1619L, 8366L, 848L, 1388L, 502L, 
                                                                                                                                              2507L, 3838L, 902L, 909L, 417L, 3045L, 1455L, 934L, 264L, 824L, 
                                                                                                                                              1809L, 364L, 492L, 617L, 799L, 1840L, 1149L, 416L, 1465L, 12569L, 
                                                                                                                                              3046L, 1274L, 4447L, 1483L, 662L, 2679L, 978L, 2121L, 1128L, 
                                                                                                                                              514L, 2714L, 3703L, 915L, 2369L, 60869L, 3498L, 414L, 7849L, 
                                                                                                                                              5127L, 3570L, 1234L, 2208L, 131L, 11559L, 1365L, 650L, 8170L, 
                                                                                                                                              15601L, 9584L, 388L, 767L, 349L, 1456L, 2234L, 402L, 2693L, 2809L, 
                                                                                                                                              1341L, 2005L, 1796L, 1741L, 830L, 228L, 6386L, 245L, 3157L, 137L, 
                                                                                                                                              6114L, 340L, 2601L, 1206L, 560L, 191L, 1103L, 1619L, 1173L, 1457L, 
                                                                                                                                              2046L, 1089L, 1364L, 8164L, 876L, 1504L, 1492L, 597L, 5641L, 
                                                                                                                                              1034L, 282L, 130L, 3881L, 9927L, 2540L, 4006L, 3635L, 2583L, 
                                                                                                                                              1945L, 1960L, 1677L, 3019L, 5502L, 907L, 659L, 8620L, 1398L, 
                                                                                                                                              2921L, 2644L, 6838L, 5390L, 1601L, 3576L, 13223L, 220L, 127L, 
                                                                                                                                              4324L, 2069L, 9806L, 2854L, 1646L, 2349L, 1389L, 1535L, 98L, 
                                                                                                                                              17866L, 5679L, 1691L, 848L, 364L, 133L, 633L, 25L, 1031L, 830L, 
                                                                                                                                              1059L, 874L, 15348L, 3141L, 15082L, 2198L, 47L, 575L, 13486L, 
                                                                                                                                              269L, 1541L, 688L, 13135L, 4510L, 437L, 1038L, 65L), Detergents_Paper = c(2674L, 
                                                                                                                                                                                                                        3293L, 3516L, 507L, 1777L, 1795L, 3140L, 3321L, 1716L, 7425L, 
                                                                                                                                                                                                                        5977L, 549L, 3881L, 6707L, 5058L, 964L, 4508L, 370L, 2767L, 2518L, 
                                                                                                                                                                                                                        2259L, 375L, 2381L, 4337L, 4482L, 4003L, 242L, 100L, 8604L, 1107L, 
                                                                                                                                                                                                                        2134L, 820L, 918L, 361L, 483L, 4239L, 862L, 6506L, 6956L, 212L, 
                                                                                                                                                                                                                        1145L, 2575L, 6899L, 9529L, 4618L, 7353L, 6792L, 24171L, 5121L, 
                                                                                                                                                                                                                        13583L, 609L, 1538L, 2587L, 5611L, 204L, 2024L, 17740L, 7572L, 
                                                                                                                                                                                                                        227L, 3084L, 4095L, 26701L, 4074L, 7677L, 1247L, 24231L, 3468L, 
                                                                                                                                                                                                                        5141L, 788L, 656L, 116L, 4173L, 1321L, 764L, 1901L, 3L, 529L, 
                                                                                                                                                                                                                        12034L, 301L, 1202L, 610L, 7818L, 3537L, 550L, 3837L, 40827L, 
                                                                                                                                                                                                                        20070L, 1579L, 165L, 454L, 69L, 627L, 18906L, 71L, 5038L, 223L, 
                                                                                                                                                                                                                        3874L, 54L, 56L, 215L, 8035L, 6766L, 4573L, 1480L, 1491L, 139L, 
                                                                                                                                                                                                                        6830L, 8969L, 2505L, 836L, 169L, 6457L, 483L, 585L, 118L, 276L, 
                                                                                                                                                                                                                        310L, 319L, 411L, 266L, 174L, 264L, 25L, 1976L, 500L, 778L, 349L, 
                                                                                                                                                                                                                        2386L, 1062L, 410L, 395L, 70L, 955L, 256L, 47L, 199L, 2447L, 
                                                                                                                                                                                                                        721L, 249L, 637L, 960L, 51L, 20L, 399L, 516L, 12591L, 73L, 1082L, 
                                                                                                                                                                                                                        283L, 113L, 170L, 255L, 352L, 302L, 7L, 11577L, 6694L, 811L, 
                                                                                                                                                                                                                        4004L, 8077L, 4424L, 3L, 232L, 13726L, 3674L, 7108L, 4973L, 1680L, 
                                                                                                                                                                                                                        79L, 69L, 7015L, 8773L, 2840L, 9836L, 153L, 4196L, 1532L, 20L, 
                                                                                                                                                                                                                        120L, 273L, 1382L, 4948L, 6907L, 239L, 334L, 58L, 949L, 3459L, 
                                                                                                                                                                                                                        6839L, 4027L, 118L, 43L, 187L, 5618L, 355L, 330L, 763L, 4314L, 
                                                                                                                                                                                                                        592L, 402L, 9959L, 14235L, 284L, 954L, 5L, 9265L, 288L, 5316L, 
                                                                                                                                                                                                                        3381L, 12420L, 244L, 19410L, 240L, 3961L, 5957L, 5828L, 13308L, 
                                                                                                                                                                                                                        130L, 4797L, 86L, 56L, 4167L, 256L, 788L, 70L, 761L, 2568L, 263L, 
                                                                                                                                                                                                                        4762L, 694L, 955L, 1566L, 284L, 409L, 325L, 1216L, 415L, 28L, 
                                                                                                                                                                                                                        72L, 828L, 343L, 412L, 586L, 1682L, 3143L, 8933L, 430L, 44L, 
                                                                                                                                                                                                                        562L, 918L, 234L, 18594L, 205L, 363L, 1547L, 111L, 392L, 3593L, 
                                                                                                                                                                                                                        730L, 967L, 780L, 49L, 429L, 2894L, 5980L, 830L, 4882L, 737L, 
                                                                                                                                                                                                                        6374L, 333L, 197L, 147L, 93L, 210L, 759L, 96L, 603L, 621L, 274L, 
                                                                                                                                                                                                                        3620L, 167L, 2328L, 1041L, 314L, 751L, 436L, 1226L, 386L, 445L, 
                                                                                                                                                                                                                        32L, 965L, 212L, 825L, 5952L, 811L, 2208L, 710L, 3712L, 4538L, 
                                                                                                                                                                                                                        290L, 2662L, 8752L, 6236L, 10069L, 11783L, 3909L, 7558L, 351L, 
                                                                                                                                                                                                                        257L, 6846L, 299L, 371L, 17120L, 183L, 857L, 3891L, 83L, 821L, 
                                                                                                                                                                                                                        706L, 12408L, 275L, 228L, 1470L, 1679L, 140L, 1272L, 387L, 88L, 
                                                                                                                                                                                                                        210L, 492L, 182L, 9606L, 178L, 38102L, 332L, 4111L, 146L, 442L, 
                                                                                                                                                                                                                        15L, 573L, 7271L, 5162L, 4595L, 15469L, 217L, 3843L, 6600L, 4621L, 
                                                                                                                                                                                                                        1184L, 12218L, 173L, 12638L, 90L, 8682L, 1333L, 184L, 9L, 6747L, 
                                                                                                                                                                                                                        536L, 232L, 468L, 159L, 179L, 1335L, 514L, 4515L, 222L, 252L, 
                                                                                                                                                                                                                        101L, 41L, 523L, 716L, 397L, 1916L, 311L, 476L, 4666L, 96L, 68L, 
                                                                                                                                                                                                                        813L, 600L, 246L, 1711L, 397L, 282L, 192L, 353L, 231L, 200L, 
                                                                                                                                                                                                                        227L, 311L, 95L, 122L, 385L, 149L, 841L, 3378L, 64L, 74L, 469L, 
                                                                                                                                                                                                                        153L, 92L, 10L, 632L, 914L, 593L, 1092L, 7883L, 2730L, 2123L, 
                                                                                                                                                                                                                        1860L, 235L, 2970L, 912L, 1135L, 3540L, 6728L, 3485L, 6740L, 
                                                                                                                                                                                                                        1580L, 6818L, 3415L, 948L, 1803L, 3213L, 108L, 5079L, 439L, 850L, 
                                                                                                                                                                                                                        84L, 241L, 1377L, 1328L, 356L, 2371L, 182L, 93L, 14841L, 168L, 
                                                                                                                                                                                                                        477L), Delicassen = c(1338L, 1776L, 7844L, 1788L, 5185L, 1451L, 
                                                                                                                                                                                                                                              545L, 2566L, 750L, 2098L, 1744L, 497L, 2931L, 602L, 2168L, 412L, 
                                                                                                                                                                                                                                              1080L, 4478L, 3181L, 501L, 2124L, 569L, 4334L, 16523L, 5778L, 
                                                                                                                                                                                                                                              57L, 833L, 518L, 5206L, 823L, 2963L, 985L, 405L, 1083L, 395L, 
                                                                                                                                                                                                                                              436L, 4626L, 714L, 433L, 2916L, 5864L, 2802L, 46L, 72L, 65L, 
                                                                                                                                                                                                                                              4985L, 1452L, 6465L, 1476L, 1163L, 2162L, 301L, 1278L, 224L, 
                                                                                                                                                                                                                                              1333L, 1130L, 1340L, 1282L, 436L, 1603L, 225L, 2017L, 964L, 1295L, 
                                                                                                                                                                                                                                              1145L, 1423L, 27L, 834L, 3095L, 144L, 1365L, 14472L, 181L, 648L, 
                                                                                                                                                                                                                                              1780L, 975L, 894L, 1009L, 167L, 1653L, 529L, 156L, 2342L, 772L, 
                                                                                                                                                                                                                                              120L, 2944L, 903L, 14351L, 46L, 3178L, 360L, 1117L, 5130L, 2698L, 
                                                                                                                                                                                                                                              244L, 709L, 217L, 63L, 132L, 323L, 3029L, 1838L, 1386L, 2498L, 
                                                                                                                                                                                                                                              548L, 1378L, 1831L, 1438L, 1236L, 3L, 1647L, 1519L, 2708L, 1561L, 
                                                                                                                                                                                                                                              1266L, 610L, 222L, 1160L, 933L, 635L, 1136L, 255L, 860L, 143L, 
                                                                                                                                                                                                                                              1621L, 918L, 483L, 2749L, 3L, 1819L, 911L, 310L, 328L, 396L, 
                                                                                                                                                                                                                                              537L, 326L, 1542L, 36L, 3271L, 929L, 2616L, 1450L, 3L, 318L, 
                                                                                                                                                                                                                                              201L, 4430L, 520L, 526L, 434L, 1440L, 1067L, 1774L, 184L, 1627L, 
                                                                                                                                                                                                                                              8L, 2153L, 3182L, 418L, 1682L, 303L, 2157L, 2233L, 610L, 446L, 
                                                                                                                                                                                                                                              238L, 2379L, 3637L, 693L, 429L, 750L, 323L, 6250L, 707L, 716L, 
                                                                                                                                                                                                                                              1442L, 1697L, 230L, 2631L, 395L, 2165L, 2794L, 8550L, 156L, 47943L, 
                                                                                                                                                                                                                                              11L, 247L, 727L, 3L, 404L, 1856L, 64L, 84L, 409L, 666L, 1142L, 
                                                                                                                                                                                                                                              1755L, 2876L, 1468L, 697L, 347L, 731L, 1681L, 6854L, 18L, 1328L, 
                                                                                                                                                                                                                                              710L, 285L, 120L, 806L, 797L, 2100L, 2870L, 1775L, 1215L, 791L, 
                                                                                                                                                                                                                                              2388L, 674L, 1158L, 6372L, 130L, 749L, 239L, 375L, 1360L, 659L, 
                                                                                                                                                                                                                                              786L, 1553L, 689L, 203L, 980L, 2137L, 490L, 834L, 7L, 2563L, 
                                                                                                                                                                                                                                              295L, 225L, 1215L, 216L, 2253L, 2564L, 1047L, 578L, 2398L, 1970L, 
                                                                                                                                                                                                                                              2784L, 610L, 659L, 572L, 291L, 710L, 5121L, 1693L, 1391L, 3265L, 
                                                                                                                                                                                                                                              615L, 373L, 987L, 3321L, 818L, 548L, 287L, 655L, 411L, 1265L, 
                                                                                                                                                                                                                                              3636L, 2563L, 3628L, 698L, 204L, 56L, 1550L, 1040L, 1824L, 1153L, 
                                                                                                                                                                                                                                              379L, 2503L, 139L, 1409L, 1721L, 1104L, 2079L, 1404L, 1384L, 
                                                                                                                                                                                                                                              2406L, 18L, 128L, 1027L, 258L, 22L, 1522L, 686L, 1060L, 741L, 
                                                                                                                                                                                                                                              1854L, 254L, 898L, 531L, 1037L, 259L, 2005L, 172L, 555L, 59L, 
                                                                                                                                                                                                                                              2410L, 211L, 1543L, 925L, 656L, 806L, 1117L, 117L, 142L, 297L, 
                                                                                                                                                                                                                                              1233L, 3508L, 1059L, 1637L, 51L, 1625L, 834L, 1113L, 229L, 573L, 
                                                                                                                                                                                                                                              1092L, 5609L, 834L, 522L, 1534L, 739L, 1043L, 1102L, 2602L, 1215L, 
                                                                                                                                                                                                                                              3486L, 2139L, 778L, 868L, 550L, 1942L, 1371L, 2158L, 1328L, 37L, 
                                                                                                                                                                                                                                              379L, 303L, 1115L, 1022L, 665L, 445L, 995L, 3137L, 195L, 1111L, 
                                                                                                                                                                                                                                              2341L, 127L, 548L, 110L, 4100L, 776L, 503L, 405L, 712L, 314L, 
                                                                                                                                                                                                                                              468L, 3105L, 447L, 342L, 558L, 296L, 2235L, 790L, 4829L, 3113L, 
                                                                                                                                                                                                                                              686L, 70L, 1426L, 1242L, 1114L, 179L, 270L, 532L, 2893L, 361L, 
                                                                                                                                                                                                                                              5120L, 1068L, 967L, 961L, 406L, 684L, 1000L, 1827L, 654L, 819L, 
                                                                                                                                                                                                                                              452L, 290L, 2213L, 743L, 247L, 375L, 1014L, 1902L, 340L, 288L, 
                                                                                                                                                                                                                                              715L, 378L, 960L, 553L, 344L, 5137L, 1892L, 4365L, 62L, 2435L, 
                                                                                                                                                                                                                                              290L, 1874L, 993L, 1063L, 776L, 1521L, 1393L, 1784L, 1218L, 668L, 
                                                                                                                                                                                                                                              249L, 1886L, 1894L, 1163L, 317L, 2501L, 2080L, 1498L, 395L, 1449L, 
                                                                                                                                                                                                                                              838L, 2204L, 2346L, 1867L, 2125L, 52L)), .Names = c("Fresh", 
                                                                                                                                                                                                                                                                                                  "Milk", "Grocery", "Frozen", "Detergents_Paper", "Delicassen"
                                                                                                                                                                                                                                              ), class = "data.frame", row.names = c(NA, -440L))
```

### Main functions

```{r label=functions}
# DESPOTA

despota <- function(data, distmat = NULL, distMethod = "euclidean", agglMethod = "ward.D2", M = 999, alpha = 0.01, listVal = FALSE, seed = NULL, ...) {
  
  date1 <- format(Sys.time(), "%a %d %b %Y, %X")
  
  stopifnot(alpha > 0 & alpha < 1 & M > 0)
  
  if(agglMethod == "ward") {
    
    warning("Method 'ward' is now called 'ward.D'")
    agglMethod <- "ward.D"
  }
  
  pmat <- pmatch(agglMethod, possib.aggl <- c("ward.D", "ward.D2", "single", 
                                              "complete", "average", "mcquitty", "median", "centroid"))
  
  if(is.na(pmat))
    stop("The possible linkages are: 'ward.D', 'ward.D2', 'single',
         'complete', 'average', 'mcquitty', 'median', 'centroid'")
  
  agglMethod <- possib.aggl[pmat]
  
  if(!is.null(seed)) set.seed(seed)
  
  if(!is.null(distmat)) {distMeasure <- distmat; attr(distMeasure, "method") <- "unknown"
                         data <- 'unknown data'} 
  else {
    
    if(!(is.na(pmatch(distMethod, "squared euclidean"))))
    {distMeasure <- dist(data)^2; attr(distMeasure, "method") <- "squared euclidean"} 
    else {distMeasure <- dist(data, method = distMethod)}
  }
  
  distMatrix <- as.matrix(distMeasure)
  
  Hcd <- as.dendrogram(hclust(distMeasure, method = agglMethod))
  
  suppressMessages(library(dendextend))
  
  matrixNodes <- sapply(c("members", "height"), get_nodes_attr, dend = Hcd)
  
  rownames(matrixNodes) <- 1:nrow(matrixNodes)
  
  listClust <- as.list(numeric(nrow(matrixNodes)))
  
  lab <- order.dendrogram(Hcd)
  
  for(i in 1: nrow(matrixNodes)) {
    
    listClust[[i]] <- lab[1 : matrixNodes[i, "members"]]
    
    if(matrixNodes[i, "members"] == 1) lab <- lab[-1]
    
  }
  
  names(listClust) <- 1:nrow(matrixNodes)
  
  findpos <- function(i) { 
    
    if(i == nrow(matrixNodes)) return(i)
    
    as.numeric(names(which(matrixNodes[i : nrow(matrixNodes), 1] == 1)[ matrixNodes[i, 1]])) 
    
  }
  
  x <- sapply(1: nrow(matrixNodes), findpos)
  
  STRING <- rep("0", nrow(matrixNodes))
  
  for(i in 2: nrow(matrixNodes)) {
    
    STRING[i: x[i]] <- ifelse(matrixNodes[i - 1, 1] == 1, 
                              paste0(STRING[i: x[i]], "2"), 
                              paste0(STRING[i: x[i]], "1"))   
    
  }
  
  matrixNodes <- data.frame(matrixNodes, code = STRING, stringsAsFactors = F)
  
  ordmatr <- with(matrixNodes, order(- height, - members))
  
  MAT <- matrixNodes[ordmatr, ]
  
  LIS <- listClust[ordmatr]
  
  limit <- which(MAT$members == 1)
  
  MAT$Leftheight[limit] <- 0
  MAT$Rightheight[limit] <- 0
  MAT$membLeft[limit] <- 0
  MAT$membRight[limit] <- 0
  
  Clusters <- list()
  length(Clusters) <- length(limit) - 1
  
  
  for(i in 1 : (limit[1] - 1)) {
    
    cod <- MAT$code[i]
    
    strinL <- paste0(cod, "1")
    strinR <- paste0(cod, "2")
    
    whi <- match(c(strinL, strinR), MAT$code)
    
    MAT$Leftheight[i] <- MAT[ whi[1], ]$height
    MAT$Rightheight[i] <- MAT[ whi[2], ]$height
    
    MAT$membLeft[i] <- MAT[ whi[1], ]$members
    MAT$membRight[i] <- MAT[ whi[2], ]$members
    
    Clusters[[i]]$Left <- sort(unlist(LIS[ whi[1] ], use.names = F))
    Clusters[[i]]$Right <- sort(unlist(LIS[ whi[2] ], use.names = F))
    
  }
  
  cluste <- 1
  
  clustest <- rep(NA, nrow(MAT))
  pvalues <- rep(NA, nrow(MAT))
  
  
  lh <- MAT$Leftheight[1]
  rh <- MAT$Rightheight[1]
  
  if(lh == 0) {
    
    cod0 <- paste0(MAT$code[1], "1")
    
    strin0 <- substr(MAT$code, 1, nchar(cod0))
    
    whi0 <- which(cod0 == strin0)
    
    clustest[ whi0 ] <- paste0("C", cluste)
    
    cluste <- cluste + 1
    
    pvalues[ whi0 ] <- NA
    
  } 
  
  if(rh == 0) {
    
    cod0 <- paste0(MAT$code[1], "2")
    
    strin0 <- substr(MAT$code, 1, nchar(cod0))
    
    whi0 <- which(cod0 == strin0)
    
    clustest[ whi0 ] <- paste0("C", cluste)
    
    cluste <- cluste + 1
    
    pvalues[ whi0 ] <- NA
    
  }
  
  list_values <- list()
  
  for(i in 2:nrow(MAT)) {
    
    if(is.na(clustest[i])) {
      
      lh <- MAT$Leftheight[i]
      rh <- MAT$Rightheight[i]
      
      if(!(lh == 0 & rh == 0) | MAT$membLeft[i] > 1 | MAT$membRight[i] > 1) {
        
        rck <- with(MAT[i, ], abs(Leftheight - Rightheight) / (height - min(c(Leftheight, Rightheight))))
        
        rcm <- numeric(M)
        
        lobs <- MAT$membLeft[i]
        robs <- MAT$membRight[i]
        
        ClusterLeft <- Clusters[[i]][[1]]
        ClusterRight <- Clusters[[i]][[2]]
        
        distMat <- as.matrix(as.dist(distMatrix[ LIS[[i]], LIS[[i]] ]))
        
        start <- 1
        
        while(start <= M){
          
          for(j in start: M) {
            
            samT <- sample(1: MAT$members[i], replace = FALSE)
            samL <- samT[1: lobs]
            samR <- samT[lobs + 1: robs]
            
            if((lh == 0 | rh == 0) & !(lobs > 1 & robs > 1)) {
              
              if(lobs == 1) { 
                
                distRightClusterPerm <- as.dist(distMat[samR, samR])
                hcij <- hclust(distRightClusterPerm, method = agglMethod)
                obsij <- ClusterRight; obsk <- ClusterLeft; heightk <- 0
                
              } else { 
                
                distLeftClusterPerm <- as.dist(distMat[samL, samL])
                hcij <- hclust(distLeftClusterPerm, method = agglMethod)
                obsk <- ClusterRight; obsij <- ClusterLeft; heightk <- 0 
              }
              
              heightij <- tail(hcij$height, 1)
              
            } else {
              
              distLeftClusterPerm <- as.dist(distMat[samL, samL])
              distRightClusterPerm <- as.dist(distMat[samR, samR])
              
              hcL <- hclust(distLeftClusterPerm, method = agglMethod)
              hcR <- hclust(distRightClusterPerm, method = agglMethod)
              
              heiL <- tail(hcL$height, 1)
              heiR <- tail(hcR$height, 1)
              
              ifelse(heiL <= heiR,
{ hcij <- hcR; heightij <- heiR; heightk <- heiL 
  obsij <- ClusterRight; obsk <- ClusterLeft },
{ hcij <- hcL; heightij <- heiL; heightk <- heiR
  obsk <- ClusterRight; obsij <- ClusterLeft })

            }

nk <- length(obsk)

splij <- split(obsij, cutree(hcij, 2))

ni <- length(splij[[1]])

nj <- length(splij[[2]])

distik <- as.dist(distMatrix[c(obsk, splij[[1]]), c(obsk, splij[[1]])])
heightik <- tail(hclust(distik, method = agglMethod)$height, 1)

distjk <- as.dist(distMatrix[c(obsk, splij[[2]]), c(obsk, splij[[2]])])
heightjk <- tail(hclust(distjk, method = agglMethod)$height, 1)

heiN <- switch(agglMethod, 
               
               ward.D = ((ni + nk) * heightik + (nj + nk) * heightjk - 
                           nk * heightij)/(ni + nj + nk),
               
               ward.D2 = sqrt(((ni + nk) * heightik^2 + (nj + nk) * heightjk^2 - 
                                 nk * heightij^2)/(ni + nj + nk)),
               
               single = min(heightik, heightjk),
               
               complete = max(heightik, heightjk),
               
               average = (ni * heightik + nj * heightjk)/(ni + nj),
               
               mcquitty = (heightik + heightjk)/2,
               
               median = (heightik + heightjk)/2 - heightij/4,
               
               centroid = (ni * heightik + nj * heightjk)/(ni + nj) - 
                 ni*nj * heightij/(ni + nj)^2)

rcm[j] <- (heightij - heightk)/(heiN - heightk)

          }

finite_val <- is.finite(rcm)

rcm <- rcm[finite_val]

start <- 1 + sum(finite_val)

        }

pval <- (sum((rcm <= rck)) +1)/(M +1)

if(pval > alpha) {
  
  cod <- MAT$code[i]
  
  strin <- substr(MAT$code, 1, nchar(cod))
  
  clustest[which(cod == strin)] <- paste0("C", cluste)
  
  pvalues[which(cod == strin)] <- pval
  
  cluste <- cluste + 1
  
} else {
  
  if(lh == 0) {
    
    cod0 <- paste0(MAT$code[i], "1")
    
    strin0 <- substr(MAT$code, 1, nchar(cod0))
    
    whi0 <- which(cod0 == strin0)
    
    clustest[ whi0 ] <- paste0("C", cluste)
    
    cluste <- cluste + 1
    
    pvalues[ whi0 ] <- pval
    
  } 
  
  if(rh == 0) {
    
    cod0 <- paste0(MAT$code[i], "2")
    
    strin0 <- substr(MAT$code, 1, nchar(cod0))
    
    whi0 <- which(cod0 == strin0)
    
    clustest[ whi0 ] <- paste0("C", cluste)
    
    cluste <- cluste + 1
    
    pvalues[ whi0 ] <- pval
    
  } 
  
}

      } else {
        
        cod <- MAT$code[i]
        
        strin <- substr(MAT$code, 1, nchar(cod))
        
        clustest[which(cod == strin)] <- paste0("C", cluste)
        
        cluste <- cluste + 1
        
      }
    }

list_values[[i]] <- list(rck = rck, rcm = rcm) 

rck <- rcm <- NULL

  }

DF <- data.frame(observation = tail(unlist(LIS), n = length(limit)), 
                 cluster = clustest[limit], p.value = pvalues[limit])
rownames(DF) <- rownames(distMatrix)[ DF$observation ]

DF$cluster <- ordered(DF$cluster, levels = unique(DF$cluster))

if(nlevels(DF$cluster) == 2) {
  
  message("DESPOTA alone is not able to choose between 1 or 2 clusters, default to 2. 
          Please, visualize the dendrogram plot.")
  
  if(!is.null(distmat)) {
    
    warning("If you want to get helped by the duda index, re-run DESPOTA providing
            the data and not the distance matrix")
    
  } else {
    
    library(fpc)
    
    cat("\nThe 'Duda and Hart' test suggests", 
        ifelse(dudahart2(data, DF$cluster, alpha)$cluster1, 
               "1 cluster.\n\n", "2 clusters.\n\n"))    
    
  }
  
}

cat("Start: ", date1, "\nEnd: ", format(Sys.time(), "%X"), "\n\n")

Args <- list(data = deparse(substitute(data)), Hcd = Hcd, 
             distMeasure = attr(distMeasure, "method"), 
             agglMethod = agglMethod, alpha = alpha, M = M, seed = seed)

if(listVal) return(list(Arguments = Args, list_values = list_values, DF = DF))

list(Arguments = Args, DF = DF) 

}

# construct the dendrogram from the DESPOTA object

plot.despota <- function(x, main = NULL, sub = NULL, ...) {
  
  data <- x$Arguments$data
  Hcd <- x$Arguments$Hcd
  distMeasure <- x$Arguments$distMeasure
  agglMethod <- x$Arguments$agglMethod
  alpha <- x$Arguments$alpha
  M <- x$Arguments$M
  DF <- x$DF
  
  labels(Hcd) <- rep(NA, length(labels(Hcd)))
  
  Hcd <- assign_values_to_leaves_edgePar(Hcd, value = DF$cluster, edgePar = "col")
  Hcd <- assign_values_to_leaves_edgePar(Hcd, value = 3, edgePar = "lwd")
  
  par0mar <- par()$mar
  
  par(mar=c(3.1, 4.1, 3.6, 2.1))
  
  plot(Hcd, main = main, sub = NA, las = 1, cex.axis = .6, ...)
  
  if(is.null(main)) {
    
    mtext(paste0("DESPOTA: ", nlevels(DF$cluster), " clusters found at alpha = ", alpha),
          side=3, line=1.8, cex=1.3)
    
  }
  
  tab <- table(DF$cluster)
  ytexts <- rep(c(-.7, -.3, .1), ceiling(length(tab)/3))
  length(ytexts) <- length(tab)
  pvs <- tapply(DF$p.value, DF$cluster, function(x) round(unique(x), 3))
  
  mtext(pvs, col = seq_len(nlevels(DF$cluster)), side=1, 
        at = .75 + tab/2 + c(0, cumsum(tab[ - length(tab)])), cex=.6, font=2, line = ytexts)
  
  if(is.null(sub)) {
    
    mtext(paste0("Data: '", data, "'"),
          side=3, line=.5, font=3)
    
    mtext(paste0("Distance: '", distMeasure, "'. Linkage: '", agglMethod,
                 "'. M = ", M), side=1, line=1.6, font=3)
    
  } else mtext(sub, side=1, line=1.5)
  
  
  abline(v = cumsum(tab[ - length(tab)]) +.5, lty = "dotted", col = "darkgrey")
  
  #par(mar=c(5.1, 4.1, 4.1, 2.1))
  par(mar = par0mar)
  
}

```

### DESPOTA on the dataset

```{r label=example}
out <- despota(customer_data, alpha = .05, seed = 31, listVal = T)

# from rev(hclust(dist(Wholesale.customers.data[,-(1:2)]), 'ward.D2')$height) I obtain:

# h3 = 181142.0203
# h4 = 162601.1790

plot.despota(out)

# level 3
segments(x0 = c(-1, -1, -1, 134.5), 
         x1 = c(134.5, 134.5, -1, 134.5),
         y0 = c(-5000, 186142, -5000, -5000),
         y1 = c(-5000, 186142, 186142, 186142),
         col = 'burlywood2')

# level 4 (395.5, 435.5, 440.5)(167601)
segments(x0 = c(395.5, 395.5, 395.5, 441), 
         x1 = c(441, 441, 395.5, 441),
         y0 = c(-5000, 167601, -5000, -5000),
         y1 = c(-5000, 167601, 167601, 167601),
         col = 'forestgreen', lty = 'longdash')
segments(x0 = 435.5, x1 = 435.5, y0 = -5000, y1 = 167601, 
         lty = 'longdash', col = 'forestgreen')

```

### Plot what happens at a specific node

```{r label=function_distribution}
GRAPHTEST <- function(rck, rcm, PROB, node, 
                      col = 'black', lty = 'solid',
                      xlim = c(0, 1)){
  
    library(scales)
    
    par0mar <- par()$mar
    par(mar=c(3.1, 4.1, 3.6, 2.1))
    
    d <- density(rcm)
        
    plot(d, cex.axis = .6, las = 1, xaxt='n', col = col, bty='n', cex.lab =.8,
         font.main = 1, lty = lty, xlim = xlim,
         main = paste('Permutation test outcome at Node', node),
         )
    
    mtext('Quantiles', 1, line = .7, cex = .8)
    
    q <- quantile(rcm, probs = PROB)
    
    seqAl <- unique(c(q, rev(seq(min(d$x), q, diff(d$x[ 1:2 ])))))
    seq1 <- unique(c(rck, rev(seq(min(d$x), rck, diff(d$x[ 1:2 ])))))
    Af <- approxfun(d$x, d$y)
    
    polygon(c(q, seqAl, min(d$x)), c(0, Af(seqAl), 0),
            border = 'pink3', col = 'pink')
    
    Af1 <- Af(seq1)
    
    polygon(c(rck, seq1, min(d$x)), c(0, Af1, 0), border = NA, 
            col = alpha('blue', .5), density = 30, angle = 90)
    
    ax1 <- c(q, rck)
    
    mtext(round(ax1, 3), 1, c(-.85, -.35), at = ax1, col = c('pink3', 'blue'),
          cex = .6, font = 2)
    
    legend('top', title = 'Figure areas', legend = c('alpha', 'p-value'), 
           density = c(NA, 30), bty = 'n', angle = 90, fill = c('pink', 'blue'), 
           border = c('pink3', 'blue'), cex = .6, text.font = 4)
    
    par(mar = par0mar)
}

```

### Plots of distributions (node 3 and 4 of the example)

```{r label=distributions}
# level 3
GRAPHTEST(rck = out$list_values[[3]]$rck, 
          rcm = out$list_values[[3]]$rcm, 
          PROB = .05, node = 3, 
          col = 'burlywood2', xlim = c(-.15, 1.3))

# level 4
GRAPHTEST(rck = out$list_values[[4]]$rck, 
          rcm = out$list_values[[4]]$rcm, 
          PROB = .05, node = 4, lty = 'longdash',
          col = 'forestgreen', xlim = c(-.05, 1.2))
```

